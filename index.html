<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="./shared.js"></script>
    <script>
        const GRAY_ICON = 'https://cdn.hyperdev.com/us-east-1%3A3d31b21c-01a0-4da2-8827-4bc6e88b7618%2Ficon-gray.svg';

        // /**
        //  * Ex:
        //  *      Input: https://trello.com/c/UIxRh6V7/13-disable-support-chat-when-impersonating-customer
        //  *      Output: 13-disable-support-chat-when-impersonating-customer
        //  */
        // function getCardPathFromUrl(url) {
        //     return url.split('/').at(5) ?? 'Error'
        // }

        // /**
        //  * Ex:
        //  *      Input: https://trello.com/c/UIxRh6V7/13-disable-support-chat-when-impersonating-customer
        //  *      Output: 13
        //  */
        // function getCardNumberFromUrl(url) {
        //     const cardPath = getCardPathFromUrl(url)

        //     return cardPath.split('-').at(0) ?? 'Error'
        // }

        // /**
        //  * Ex:
        //  *      Input: https://trello.com/c/UIxRh6V7/13-disable-support-chat-when-impersonating-customer
        //  *      Output: disable-support-chat-when-impersonating-customer
        //  */
        // function getCardSlugFromUrl(url) {
        //     const cardPath = getCardPathFromUrl(url)
        //     const cardNumber = getCardNumberFromUrl(url)

        //     return cardPath.replace(`${cardNumber}-`, '')
        // }

        TrelloPowerUp.initialize({
            // TODO: Refactor to "board-button"
            'card-buttons': function (trello, options) {
                return [
                    {
                        icon: GRAY_ICON,
                        text: 'Branch Prefix',
                        callback: function (trello) {
                            return trello.popup({
                                title: 'Branch Prefix',
                                url: 'branch-prefix.html',
                            });
                        },
                    },
                ];
            },
            'card-back-section': function (trello, options) {
                return trello.board('id', 'name')
                    .then((board) => {
                        return trello.card('id', 'name', 'url')
                            .then((card) => {
                                return trello.get('board', 'shared', 'branchPrefix')
                                    .then(function (branchPrefix) {
                                        let branchName = 'Unknown'

                                        if (typeof branchPrefix !== 'string') {
                                            branchPrefix = 'Undefined'
                                        }
        
                                        try {
                                            const cardNumber = getCardNumberFromUrl(card.url)
                                            const cardSlug = getCardSlugFromUrl(card.url)
                                            branchName = `${branchPrefix}-${cardNumber}/${cardSlug}`
                                        } catch (error) {
                                            branchName = 'Error'
                                            console.error(error)
                                        }
        
                                        return {
                                            title: branchName,
                                            icon: GRAY_ICON,
                                            content: {
                                                type: 'iframe',
                                                url: trello.signUrl('./card-back-section.html'),
                                                height: 50,
                                            },
                                        }
                                    })
                                
                            })
                    })
            },
            'card-badges': function (trello, options) {
                return trello.board('id', 'name')
                    .then((board) => {
                        return trello.card('id', 'name', 'url')
                            .then((card) => {
                                return trello.get('board', 'shared', 'branchPrefix')
                                    .then(function (branchPrefix) {
                                        let taskCode = 'Unknown'
        
                                        try {
                                            const cardNumber = getCardNumberFromUrl(card.url)
                                            taskCode = `${branchPrefix}-${cardNumber}`
                                            taskCode = taskCode.toUpperCase()
                                        } catch (error) {
                                            taskCode = 'Error'
                                            console.error(error)
                                        }
        
                                        return [
                                            {
                                                text: taskCode,
                                                icon: GRAY_ICON,
                                                color: 'light-gray',
                                            },
                                        ];
                                    })
                            })
                    })
            },
        })
    </script>
</body>
</html>
